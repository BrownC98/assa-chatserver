# ASSA 채팅 서버 리팩토링 계획서

## 1. 리팩토링 개요

### 1.1 목표

- **주요 목표**: 비대한 클래스를 기능 단위로 분리하여 유지보수성 향상
- **부차 목표**: TDD 방법론 도입을 통한 안전한 구조 개선
- **최종 목표**: 디버깅과 유지보수가 용이한 모듈화된 구조 구축

### 1.2 리팩토링 원칙

- **TDD 방법론 도입**: 테스트 작성 → 리팩토링 → 테스트 통과 사이클 적용
- **기존 기능 유지**: 새로운 기능 추가 없이 구조 개선에만 집중
- **점진적 개선**: 기능을 유지하면서 단계적으로 구조 개선
- **실용성 우선**: 과도한 추상화보다는 실용적인 개선에 집중

## 2. 현재 문제점 분석

### 2.1 주요 문제점

1. **User 클래스 비대화** (757줄)

   - 연결 관리, 메시지 처리, WebRTC 시그널링 등 다중 책임
   - 디버깅 및 유지보수 어려움
   - 단일 책임 원칙 위반

2. **기능 분산 부족**

   - 관련 기능들이 여러 클래스에 분산
   - 코드 재사용성 부족
   - 테스트 작성 어려움

3. **의존성 복잡도**
   - 클래스 간 강한 결합
   - 변경 시 영향 범위 예측 어려움

## 3. 리팩토링 전략

### 3.1 TDD 적용 전략

```
1. 기존 기능에 대한 통합 테스트 작성
2. 리팩토링 대상 기능의 단위 테스트 작성
3. 테스트가 통과하는 최소한의 리팩토링 수행
4. 테스트 실행 및 검증
5. 다음 단계로 진행
```

### 3.2 클래스 분리 전략

- **기능별 분리**: 연결 관리, 메시지 처리, WebRTC 처리를 독립 클래스로 분리
- **계층별 분리**: 비즈니스 로직과 데이터 처리 로직 분리
- **책임별 분리**: 각 클래스가 하나의 명확한 책임만 가지도록 설계

## 4. 리팩토링 단계별 계획

### Phase 1: 테스트 인프라 구축 (1-2일)

#### 1.1 TDD 환경 설정

- **목표**: TDD 방법론 적용을 위한 테스트 기반 구축
- **작업 내용**:
  ```
  ✓ 기존 JUnit 4.11 활용한 테스트 환경 설정
  ✓ TDD 사이클 적용을 위한 테스트 구조 설계
  ✓ Given-When-Then 패턴 적용
  ✓ 테스트 네이밍 컨벤션 정의
  ```

#### 1.2 기존 기능 통합 테스트 작성

- **목표**: 리팩토링 중 기능 손실 방지
- **테스트 대상**:
  ```
  ✓ 사용자 연결/해제 테스트
  ✓ 메시지 송수신 테스트
  ✓ 채팅방 생성/참가/퇴장 테스트
  ✓ WebRTC 시그널링 테스트
  ```

### Phase 2: User 클래스 분리 (3-4일)

#### 2.1 연결 관리 분리

- **새 클래스**: `UserConnectionManager`
- **책임**: 소켓 연결, 해제, 상태 관리
- **분리 대상 메서드**:
  ```java
  - replaceSocket()
  - run() // 소켓 리스닝 부분
  - 연결 상태 관리 로직
  ```

#### 2.2 메시지 처리 분리

- **새 클래스**: `MessageHandler`
- **책임**: 채팅 메시지 처리, 방 관리
- **분리 대상 메서드**:
  ```java
  - SendMessage()
  - checkReceive()
  - createRoom()
  - roomInfo()
  - roomExit()
  - roomInvite()
  ```

#### 2.3 WebRTC 처리 분리

- **새 클래스**: `WebRTCSignalingHandler`
- **책임**: WebRTC 시그널링 전용 처리
- **분리 대상 메서드**:
  ```java
  - createVideoRoom()
  - joinVideoRoom()
  - exitVideoRoom()
  - handleSDP()
  - handleIceCandidate()
  - mediaStatus()
  - getVideoRoomParticipant()
  ```

#### 2.4 User 클래스 재설계

- **새로운 역할**: 사용자 정보 관리 및 핸들러 조정
- **구조**:

  ```java
  public class User extends Thread {
      private UserConnectionManager connectionManager;
      private MessageHandler messageHandler;
      private WebRTCSignalingHandler webrtcHandler;

      // 사용자 기본 정보만 관리
      // 각 핸들러에 작업 위임
  }
  ```

### Phase 3: 공통 모듈 개선 (2-3일)

#### 3.1 메시지 큐 개선

- **현재**: `LinkedList<String> messageQueue`
- **개선**: `BlockingQueue<Message>` 사용
- **이유**:
  - 스레드 안전성 향상
  - 타입 안전성 확보
  - 더 나은 성능 (포트폴리오 규모에 적합)

#### 3.2 데이터베이스 연결 개선

- **현재**: 단일 Connection 재사용
- **개선**: HikariCP 경량 커넥션 풀 도입
- **설정**: 최소 2개, 최대 5개 연결 (10명 규모에 적합)
- **이유**:
  - 동시성 처리 개선
  - 연결 안정성 향상
  - 포트폴리오 수준에 적합한 오버헤드

#### 3.3 로깅 시스템 개선

- **목표**: 디버깅 용이성 향상
- **개선사항**:
  ```
  ✓ 구조화된 로그 메시지 포맷
  ✓ 사용자별 로그 추적 ID 추가
  ✓ 메서드 진입/종료 로그 표준화
  ✓ 에러 로그 상세화
  ```

### Phase 4: 코드 품질 개선 (2일)

#### 4.1 상수 및 설정 관리

- **새 클래스**: `Constants` 클래스 생성
- **개선사항**:
  ```java
  public final class Constants {
      public static final int MAX_MESSAGE_LENGTH = 1000;
      public static final int MAX_ROOM_NAME_LENGTH = 50;
      public static final long CONNECTION_TIMEOUT = 30000;
      // 매직 넘버 제거
  }
  ```

#### 4.2 예외 처리 표준화

- **새 클래스**: 커스텀 예외 클래스들
  ```java
  - ChatServerException
  - UserConnectionException
  - MessageProcessingException
  - WebRTCSignalingException
  ```

#### 4.3 코드 정리

- **작업 내용**:
  ```
  ✓ 사용하지 않는 import 제거
  ✓ 변수명 일관성 확보
  ✓ JavaDoc 주석 추가
  ✓ 코드 포맷팅 통일
  ```

### Phase 5: 테스트 완성 및 검증 (2일)

#### 5.1 단위 테스트 작성

- **목표 커버리지**: 핵심 비즈니스 로직 70% 이상
- **테스트 대상**:
  ```
  ✓ MessageHandler 단위 테스트
  ✓ WebRTCSignalingHandler 단위 테스트
  ✓ UserConnectionManager 단위 테스트
  ✓ DBHelper 단위 테스트
  ```

#### 5.2 통합 테스트 보완

- **시나리오 테스트**:
  ```
  ✓ 다중 사용자 채팅 시나리오
  ✓ 영상통화 시작/종료 시나리오
  ✓ 연결 끊김/재연결 시나리오
  ✓ 동시 접속 부하 테스트 (10명)
  ```

## 5. 새로운 패키지 구조

### 5.1 리팩토링 후 구조

```
com.teamnova
├── Main.java
├── ChatServer.java
├── User.java (경량화)
├── connection/
│   ├── UserConnectionManager.java
│   └── ConnectionState.java
├── message/
│   ├── MessageHandler.java
│   ├── MessageQueue.java
│   └── MessageProcessor.java
├── webrtc/
│   ├── WebRTCSignalingHandler.java
│   ├── VideoRoomManager.java
│   └── SignalingProcessor.java
├── database/
│   ├── DBHelper.java (개선)
│   ├── ConnectionPool.java
│   └── TransactionManager.java
├── command/ (기존 유지)
├── dto/ (기존 유지)
├── utils/
│   ├── Constants.java (신규)
│   ├── TimeUtils.java
│   └── LoggingUtils.java (신규)
└── exception/
    ├── ChatServerException.java
    ├── UserConnectionException.java
    ├── MessageProcessingException.java
    └── WebRTCSignalingException.java
```

## 6. 성능 최적화 방안

### 6.1 메모리 관리

- **메시지 큐**: `BlockingQueue` 사용으로 메모리 효율성 향상
- **객체 풀링**: 자주 생성되는 객체들의 재사용 패턴 도입
- **가비지 컬렉션**: 불필요한 객체 생성 최소화

### 6.2 동시성 처리

- **스레드 안전성**: `ConcurrentHashMap` 활용 유지
- **락 최소화**: 세밀한 동기화 블록 사용
- **데드락 방지**: 일관된 락 순서 적용

### 6.3 데이터베이스 최적화

- **커넥션 풀**: HikariCP 도입 (최소 2, 최대 5 연결)
- **쿼리 최적화**: PreparedStatement 재사용
- **배치 처리**: 다중 메시지 처리 시 배치 insert 활용

## 7. 테스트 전략

### 7.1 테스트 피라미드

```
        /\
       /  \
      /E2E \ (5% - 전체 시나리오)
     /______\
    /        \
   /Integration\ (25% - 모듈 간 연동)
  /__________\
 /            \
/  Unit Tests  \ (70% - 개별 기능)
/______________\
```

### 7.2 테스트 환경

- **단위 테스트**: JUnit 5 + Mockito
- **통합 테스트**: H2 인메모리 DB + TestContainers (필요시)
- **성능 테스트**: 간단한 부하 테스트 (10명 동시 접속)

### 7.3 TDD 사이클

```
1. Red: 실패하는 테스트 작성
2. Green: 테스트를 통과하는 최소 코드 작성
3. Refactor: 코드 개선 (테스트 유지)
4. Repeat: 다음 기능으로 반복
```

## 8. 품질 관리

### 8.1 코드 리뷰 체크리스트

- [ ] 단일 책임 원칙 준수
- [ ] 메서드 길이 50줄 이내
- [ ] 매개변수 5개 이내
- [ ] 적절한 예외 처리
- [ ] 의미있는 변수/메서드명
- [ ] JavaDoc 주석 작성

### 8.2 성능 기준

- **메모리 사용량**: 10명 접속 시 500MB 이내
- **응답 시간**: 메시지 전송 100ms 이내
- **동시 처리**: 10명 동시 메시지 송신 처리 가능

## 9. 리스크 관리

### 9.1 주요 리스크

1. **기능 손실**: 리팩토링 중 기존 기능 손상
2. **성능 저하**: 구조 변경으로 인한 성능 영향
3. **호환성 문제**: 안드로이드 클라이언트와의 호환성

### 9.2 리스크 대응

- **기능 손실**: 포괄적인 통합 테스트로 방지
- **성능 저하**: 각 단계별 성능 테스트 실행
- **호환성 문제**: API 인터페이스 유지, 점진적 변경

## 10. 일정 및 마일스톤

### 10.1 전체 일정: 10-12일

```
Week 1:
├── Day 1-2: Phase 1 (테스트 인프라)
├── Day 3-6: Phase 2 (User 클래스 분리)
└── Day 7: Phase 3 시작 (공통 모듈)

Week 2:
├── Day 8-9: Phase 3 완료 (공통 모듈)
├── Day 10: Phase 4 (코드 품질)
├── Day 11-12: Phase 5 (테스트 완성)
└── 최종 검증 및 문서화
```

### 10.2 주요 마일스톤

- **M1**: 테스트 인프라 완성 (Day 2)
- **M2**: User 클래스 분리 완성 (Day 6)
- **M3**: 공통 모듈 개선 완성 (Day 9)
- **M4**: 전체 리팩토링 완성 (Day 12)

## 11. 성공 기준

### 11.1 정량적 기준

- [ ] 테스트 커버리지 70% 이상 달성
- [ ] User 클래스 크기 200줄 이내로 축소
- [ ] 평균 메서드 길이 30줄 이내
- [ ] 클래스당 평균 책임 수 1-2개

### 11.2 정성적 기준

- [ ] 새로운 기능 추가 시 수정 범위 예측 가능
- [ ] 버그 발생 시 원인 파악 시간 단축
- [ ] 코드 리뷰 시 이해도 향상
- [ ] 유지보수 작업 효율성 개선

## 12. 후속 계획

### 12.1 단기 개선 (리팩토링 완료 후)

- 성능 모니터링 도구 추가
- 로그 분석 자동화
- 배포 스크립트 개선

### 12.2 중장기 개선 (필요시)

- Docker 컨테이너화
- CI/CD 파이프라인 구축
- 모니터링 대시보드 구축

---

**문서 버전**: 1.0  
**작성일**: 2024년  
**작성자**: Team Nova  
**예상 완료일**: 리팩토링 시작일 + 12일

> 이 계획서는 ASSA 채팅 서버의 체계적인 리팩토링을 위한 가이드라인이며, TDD 방법론을 적용하여 안전하고 효과적인 코드 개선을 목표로 합니다.
