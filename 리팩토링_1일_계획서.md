# ASSA 채팅 서버 1일 리팩토링 계획서

## 1. 리팩토링 개요 (수정됨)

### 1.1 목표

- **주요 목표**: User 클래스(757줄)를 3개 핸들러로 분리
- **시간 제약**: 1일(8시간) 내 완료
- **방법**: 기존 JUnit 4.11 활용한 안전한 리팩토링

### 1.2 핵심 원칙

- **기존 기능 100% 유지**: 새로운 기능 추가 금지
- **최소한의 테스트**: 핵심 기능만 테스트 작성
- **점진적 분리**: 컴파일 에러 없이 단계별 진행
- **실용성 우선**: 완벽함보다는 동작하는 개선

## 2. 1일 타임라인 (8시간)

### Phase 1: 준비 및 분석 (1시간) - 09:00~10:00

```
✓ 현재 User 클래스 분석 및 분리 지점 파악
✓ 기본 테스트 환경 확인 (JUnit 4.11)
✓ 백업 생성 (Git commit)
✓ 분리할 메서드 목록 작성
```

### Phase 2: 핵심 테스트 작성 (1.5시간) - 10:00~11:30

```
✓ 기존 기능 보호용 통합 테스트 작성
  - 사용자 연결/해제 테스트
  - 메시지 송수신 테스트
  - WebRTC 기본 시그널링 테스트
✓ 테스트 실행 및 현재 상태 확인
```

### Phase 3: UserConnectionManager 분리 (1.5시간) - 11:30~13:00

```
✓ 연결 관리 관련 메서드 분리
  - replaceSocket()
  - 소켓 상태 관리 로직
  - 연결 해제 처리
✓ User 클래스에서 ConnectionManager 사용하도록 수정
✓ 테스트 실행 및 검증
```

### 점심시간 (1시간) - 13:00~14:00

### Phase 4: MessageHandler 분리 (2시간) - 14:00~16:00

```
✓ 메시지 처리 관련 메서드 분리
  - SendMessage()
  - checkReceive()
  - createRoom(), roomInfo(), roomExit()
✓ User 클래스에서 MessageHandler 사용하도록 수정
✓ 테스트 실행 및 검증
```

### Phase 5: WebRTCSignalingHandler 분리 (1.5시간) - 16:00~17:30

```
✓ WebRTC 관련 메서드 분리
  - createVideoRoom(), joinVideoRoom()
  - handleSDP(), handleIceCandidate()
  - mediaStatus() 관련 로직
✓ User 클래스에서 WebRTCHandler 사용하도록 수정
✓ 테스트 실행 및 검증
```

### Phase 6: 최종 정리 및 검증 (0.5시간) - 17:30~18:00

```
✓ 전체 테스트 실행
✓ 코드 정리 (import, 주석)
✓ 최종 커밋
```

## 3. 분리할 클래스 구조

### 3.1 UserConnectionManager

```java
public class UserConnectionManager {
    private Socket socket;
    private boolean isConnected;

    public void replaceSocket(Socket newSocket) { /* 기존 로직 */ }
    public boolean isConnected() { /* 기존 로직 */ }
    public void disconnect() { /* 기존 로직 */ }
    // 연결 관리 관련 메서드들만
}
```

### 3.2 MessageHandler

```java
public class MessageHandler {
    private User user;
    private DBHelper dbHelper;

    public void sendMessage(String message) { /* 기존 로직 */ }
    public void checkReceive() { /* 기존 로직 */ }
    public void createRoom(String roomName) { /* 기존 로직 */ }
    // 메시지/채팅방 관련 메서드들만
}
```

### 3.3 WebRTCSignalingHandler

```java
public class WebRTCSignalingHandler {
    private User user;

    public void createVideoRoom(String roomId) { /* 기존 로직 */ }
    public void handleSDP(String sdp) { /* 기존 로직 */ }
    public void handleIceCandidate(String candidate) { /* 기존 로직 */ }
    // WebRTC 관련 메서드들만
}
```

### 3.4 수정된 User 클래스

```java
public class User extends Thread {
    // 기본 사용자 정보
    private String userId;
    private String userName;

    // 핸들러들
    private UserConnectionManager connectionManager;
    private MessageHandler messageHandler;
    private WebRTCSignalingHandler webrtcHandler;

    // 생성자에서 핸들러 초기화
    public User(Socket socket) {
        this.connectionManager = new UserConnectionManager(socket);
        this.messageHandler = new MessageHandler(this);
        this.webrtcHandler = new WebRTCSignalingHandler(this);
    }

    // 기존 메서드들은 해당 핸들러로 위임
    public void sendMessage(String msg) {
        messageHandler.sendMessage(msg);
    }

    // run() 메서드는 유지하되 핸들러 사용
}
```

## 4. 테스트 전략 (JUnit 4.11 활용)

### 4.1 기본 테스트 구조

```java
public class UserRefactoringTest {
    private User user;
    private Socket mockSocket;

    @Before
    public void setUp() {
        // 테스트 환경 설정
    }

    @Test
    public void testMessageSending() {
        // Given-When-Then 패턴
    }

    @After
    public void tearDown() {
        // 정리
    }
}
```

### 4.2 핵심 테스트 케이스

```
✓ 사용자 연결 테스트
✓ 메시지 송신 테스트
✓ 채팅방 생성 테스트
✓ WebRTC 시그널링 기본 테스트
✓ 연결 해제 테스트
```

## 5. 리스크 관리

### 5.1 시간 부족 시 우선순위

1. **1순위**: UserConnectionManager 분리 (가장 독립적)
2. **2순위**: MessageHandler 분리 (핵심 기능)
3. **3순위**: WebRTCSignalingHandler 분리 (선택적)

### 5.2 문제 발생 시 대응

- **컴파일 에러**: 즉시 이전 단계로 롤백
- **테스트 실패**: 해당 기능만 원복 후 다음 단계 진행
- **시간 초과**: 완료된 부분만 커밋하고 나머지는 다음 기회에

## 6. 성공 기준 (1일 기준)

### 6.1 최소 성공 기준

- [ ] User 클래스 크기 50% 이상 축소 (757줄 → 400줄 이하)
- [ ] 최소 1개 핸들러 분리 완료
- [ ] 기존 기능 100% 동작

### 6.2 이상적 성공 기준

- [ ] 3개 핸들러 모두 분리 완료
- [ ] User 클래스 200줄 이하로 축소
- [ ] 핵심 테스트 5개 이상 작성

## 7. 다음 단계 (1일 완료 후)

### 7.1 추가 개선 사항 (별도 일정)

- 더 세밀한 단위 테스트 작성
- 예외 처리 개선
- 로깅 시스템 개선
- 성능 최적화

### 7.2 장기 계획

- 패키지 구조 재정리
- 디자인 패턴 적용
- 문서화 개선

---

**목표**: 1일 8시간 내 User 클래스 분리를 통한 유지보수성 향상  
**핵심**: 기존 기능 유지 + 안전한 구조 개선  
**도구**: 기존 JUnit 4.11 + 점진적 리팩토링

> 완벽함보다는 **동작하는 개선**을 목표로, 시간 내에 실질적인 구조 개선을 달성합니다.
