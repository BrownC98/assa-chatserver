# ASSA 채팅 서버 요건 정의서

## 1. 프로젝트 개요

### 1.1 프로젝트명

**ASSA Chat Server** (실시간 채팅 소켓 서버 및 WebRTC 시그널링 서버)

### 1.2 프로젝트 목적

- 안드로이드 앱을 위한 실시간 채팅 기능 제공하는 소켓 서버 구현
- WebRTC 기반 영상통화를 위한 시그널링 서버 기능 제공
- 다중 사용자 채팅방 관리 및 메시지 전송/수신 처리
- 영상회의 방 생성 및 참가자 관리
- **포트폴리오용 프로젝트** (소규모 사용자 대상)

### 1.3 기술 스택

- **언어**: Java 20
- **빌드 도구**: Maven
- **데이터베이스**: MySQL 8.0
- **로깅**: Log4j2
- **JSON 처리**: Gson 2.13.1
- **네트워킹**: Java Socket API
- **클라이언트**: Android 앱

### 1.4 시스템 규모

- **예상 동시 접속자**: 10명 내외
- **대상**: 포트폴리오 및 데모용
- **서버 포트**: 12345

## 2. 기능 요구사항

### 2.1 채팅 서버 기능

#### 2.1.1 사용자 연결 관리

- **CONNECT**: 클라이언트 소켓 연결 처리
  - 사용자 ID 기반 연결 관리
  - 기존 연결 시 소켓 교체 지원
  - 오프라인 메시지 큐 처리
- **DISCONNECT**: 클라이언트 연결 해제 처리
  - 안전한 소켓 종료
  - 사용자 목록에서 제거
- 동시 다중 사용자 접속 지원 (멀티스레딩)
- 사용자별 메시지 큐 관리 (오프라인 메시지 대응)

#### 2.1.2 채팅방 관리

- **CREATE_ROOM**: 일반 채팅방 생성
  - 1:1 채팅방 (NORMAL 타입)
  - 자동 방 ID 생성
- **CREATE_OPEN_CHAT**: 오픈 채팅방 생성
  - 다중 사용자 참여 가능
  - 방 이름, 설명 설정
  - 방장 권한 부여
- **ROOM_INFO**: 채팅방 정보 조회
  - 방 메타데이터 조회
  - 참가자 목록 조회
  - 메시지 히스토리 조회
- **EXIT_ROOM**: 채팅방 나가기
  - 일반 사용자 퇴장
  - 방장 퇴장 시 방 삭제
- **INVITE**: 채팅방 초대 기능
  - 사용자 ID 기반 초대
  - 오프라인 사용자 초대 지원

#### 2.1.3 메시지 처리

- **SEND_MESSAGE**: 실시간 메시지 전송
  - 텍스트 메시지
  - 이미지 메시지 (업로드 지원)
  - 시스템 메시지 (영상통화 시작/종료)
- **CHECK_RECEIVE**: 메시지 수신 확인 처리
  - 전송 상태 업데이트
  - 읽음 확인 처리
- **메시지 타입 지원**:
  - `TEXT`: 일반 텍스트 메시지
  - `IMAGE`: 이미지 메시지
  - `VIDEO`: 비디오 메시지
  - `VIDEO_ROOM_OPEN`: 영상통화 시작 알림
  - `VIDEO_ROOM_CLOSE`: 영상통화 종료 알림
- **메시지 상태 관리**:
  - 읽음 상태: `READ`, `UNREAD`
  - 전송 상태: `PENDING`, `SENT`, `FAILED`

### 2.2 WebRTC 시그널링 서버 기능

#### 2.2.1 영상회의 방 관리

- **CREATE_VIDEO_ROOM**: 영상회의 방 생성
  - UUID 기반 고유 방 ID 생성
  - 방장 권한 부여
  - 채팅방과 연동
- **JOIN_VIDEO_ROOM**: 영상회의 방 참가
  - 기존 참가자에게 신규 참가자 알림
  - 신규 참가자에게 전체 참가자 목록 제공
  - 사용자 프로필 정보 공유
- **EXIT_VIDEO_ROOM**: 영상회의 방 나가기
  - 일반 참가자 퇴장 처리
  - 방장 퇴장 시 방 종료 및 알림
  - 빈 방 자동 삭제
- **GET_VIDEO_ROOM_PARTICIPANT**: 참가자 목록 조회
  - 실시간 참가자 목록 반환
  - 사용자 프로필 정보 포함

#### 2.2.2 WebRTC 시그널링

- **SDP**: Session Description Protocol 처리
  - `OFFER`: 연결 제안
  - `ANSWER`: 연결 응답
  - `PRANSWER`: 임시 응답
  - `ROLLBACK`: 연결 롤백
  - 1:1 시그널링 중계
- **ICE_CANDIDATE**: ICE 후보 교환 처리
  - NAT 통과를 위한 후보 정보 교환
  - 타겟 사용자별 개별 전송
- **MEDIA_STATUS**: 미디어 상태 관리
  - 카메라 ON/OFF 상태 전파
  - 마이크 ON/OFF 상태 전파
  - 실시간 상태 동기화

## 3. 데이터베이스 요구사항

### 3.1 주요 테이블 구조

- **users**: 사용자 정보
  - id, nickname, profile_image 등
- **chat_rooms**: 채팅방 정보
  - id, room_name, description, room_type, master_user_id
- **user_chatroom_map**: 사용자-채팅방 매핑
  - chat_room_id, user_id, entered_at
- **messages**: 메시지 저장
  - id, chat_room_id, sender_id, content, type, sended_at
- **message_read_status**: 메시지 읽음 상태
  - message_id, user_id, read_at
- **response_commands**: 응답 명령 저장
  - 전송 상태 추적용

### 3.2 데이터 영속성

- **메시지 보관**: 무제한 (현재 정책)
- **채팅방 정보**: 영구 저장
- **사용자 참여 이력**: 영구 보관
- **명령 전송 상태**: 추적 및 보관

### 3.3 데이터베이스 연결

- **호스트**: 43.200.172.122:3306
- **데이터베이스**: assa
- **연결 관리**: 싱글톤 패턴 (DBHelper)

## 4. 비기능 요구사항

### 4.1 성능 요구사항

- **동시 접속자**: 최대 10명 지원
- **실시간 메시지 전송**: 지연시간 최소화
- **멀티스레딩**: 사용자별 독립 스레드 처리
- **메모리 관리**: ConcurrentHashMap, CopyOnWriteArrayList 사용

### 4.2 안정성 요구사항

- **연결 관리**: 소켓 끊김 시 안전한 정리
- **예외 처리**: 모든 명령 처리에 try-catch 적용
- **로깅**: 디버깅 및 유지보수용 상세 로그
- **데이터 일관성**: 트랜잭션 처리

### 4.3 확장성 요구사항

- **Command Pattern**: 새로운 기능 추가 용이
- **모듈화**: DTO, Command, Utils 패키지 분리
- **설정 외부화**: config.properties 활용
- **플러그인 구조**: BaseCommand 상속을 통한 확장

### 4.4 보안 요구사항

- **현재 단계**: 기본 보안만 적용
- **향후 확장**: 인증/암호화 기능 추가 가능한 구조

## 5. 시스템 아키텍처

### 5.1 전체 시스템 구조

```
Android App (Client)
    ↕ Socket Communication
ASSA Chat Server
    ├── ChatServer (메인 서버)
    ├── User (클라이언트 연결 관리)
    ├── ChatRoom (채팅방 관리)
    ├── VideoRoom (영상회의 방 관리)
    └── DBHelper (데이터베이스 처리)
    ↕ JDBC
MySQL Database
```

### 5.2 명령 처리 아키텍처

```
JSON Message → Action Enum → BaseCommand → 구체적 Command 클래스
├── 채팅 관련
│   ├── ConnectCommand
│   ├── CreateRoomCommand
│   ├── SendMessageCommand
│   ├── InviteCommand
│   └── ExitRoomCommand
└── WebRTC 관련
    ├── CreateVideoRoomCommand
    ├── JoinVideoRoomCommand
    ├── SDPCommand
    ├── IceCandidateCommand
    └── MediaStatusCommand
```

### 5.3 패키지 구조

```
com.teamnova
├── Main.java (진입점)
├── ChatServer.java (메인 서버)
├── User.java (사용자 관리)
├── ChatRoom.java (채팅방)
├── VideoRoom.java (영상회의방)
├── DBHelper.java (DB 처리)
├── PropertiesManager.java (설정 관리)
├── command/ (명령 처리)
│   ├── Action.java
│   ├── BaseCommand.java
│   └── [각종 Command 클래스들]
├── dto/ (데이터 전송 객체)
│   ├── Message.java
│   ├── RoomData.java
│   └── [기타 DTO들]
└── Utils/ (유틸리티)
    ├── TimeUtils.java
    └── [기타 유틸들]
```

## 6. 배포 및 운영 요구사항

### 6.1 설정 관리

- **설정 파일**: `src/main/resources/config.properties`
- **주요 설정**:
  ```properties
  SERVER_PORT=12345
  DB_URL=jdbc:mysql://43.200.172.122:3306/assa
  DB_USER=root
  DB_PW=root1234
  ```

### 6.2 로깅 시스템

- **로깅 프레임워크**: Log4j2
- **설정 파일**: `src/main/resources/log4j2.xml`
- **로그 레벨**: DEBUG (개발용), INFO (운영용)
- **로그 내용**:
  - 사용자 연결/해제
  - 메시지 송수신
  - 명령 처리 과정
  - 에러 및 예외 상황

### 6.3 빌드 및 배포

- **빌드 도구**: Maven
- **실행 파일**: Maven Shade Plugin으로 Fat JAR 생성
- **메인 클래스**: `com.teamnova.Main`
- **실행 명령**: `java -jar assa-chat-server-1.0-SNAPSHOT.jar`

### 6.4 개발 환경

- **Java 버전**: OpenJDK 20
- **IDE**: 제한 없음 (IntelliJ IDEA, Eclipse, VS Code 등)
- **데이터베이스**: MySQL 8.0 이상

## 7. 클라이언트 연동 사양

### 7.1 통신 프로토콜

- **프로토콜**: TCP Socket
- **데이터 형식**: JSON
- **인코딩**: UTF-8

### 7.2 메시지 형식

```json
{
  "action": "SEND_MESSAGE",
  "requesterId": 123,
  "roomId": 456,
  "content": "안녕하세요",
  "messageType": "TEXT",
  "createdAT": "2024-01-01T12:00:00Z"
}
```

### 7.3 Android 앱 요구사항

- **최소 SDK**: API 21 (Android 5.0) 이상 권장
- **네트워크 권한**: INTERNET 권한 필요
- **WebRTC**: 카메라, 마이크 권한 필요
- **이미지 업로드**: 저장소 접근 권한 필요

## 8. 테스트 요구사항

### 8.1 단위 테스트

- **프레임워크**: JUnit 4.11
- **테스트 대상**: 주요 비즈니스 로직
- **커버리지**: 핵심 기능 80% 이상

### 8.2 통합 테스트

- **데이터베이스 연동**: 실제 DB 연결 테스트
- **소켓 통신**: 클라이언트-서버 통신 테스트
- **동시 접속**: 다중 사용자 시나리오 테스트

### 8.3 성능 테스트

- **부하 테스트**: 10명 동시 접속 시나리오
- **메시지 처리**: 초당 메시지 처리량 측정
- **메모리 사용량**: 장시간 운영 시 메모리 누수 확인

## 9. 유지보수 및 확장 계획

### 9.1 단기 개선사항

- 에러 처리 강화
- 로그 분석 도구 연동
- 성능 모니터링 추가

### 9.2 중장기 확장사항

- 사용자 인증 시스템 추가
- 메시지 암호화 기능
- 파일 업로드 서버 분리
- 클러스터링 지원
- Redis 캐시 도입

### 9.3 문서화

- API 문서 작성
- 배포 가이드 작성
- 트러블슈팅 가이드 작성

---

**문서 버전**: 1.0  
**작성일**: 2024년  
**작성자**: Team Nova  
**검토자**: -  
**승인자**: -

> 이 문서는 ASSA 채팅 서버 프로젝트의 요구사항을 정의하며, 개발 과정에서 참조 문서로 활용됩니다.
